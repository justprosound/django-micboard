#!/usr/bin/env python
"""
Add all 319 campus IPs to Shure System API via PUT method and monitor discovery.
"""
import os
import sys
import time
import requests
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Setup Django
sys.path.insert(0, '/home/skuonen/django-micboard')
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'demo.settings')
import django
django.setup()

from django.conf import settings

config = getattr(settings, "MICBOARD_CONFIG", {})
BASE_URL = config.get("SHURE_API_BASE_URL", "https://localhost:10000")
SHARED_KEY = config.get("SHURE_API_SHARED_KEY")

if not SHARED_KEY:
    print("Error: SHURE_API_SHARED_KEY not set")
    sys.exit(1)

headers = {
    "Authorization": f"Bearer {SHARED_KEY}",
    "x-api-key": str(SHARED_KEY),
    "Content-Type": "application/json"
}

# All 319 unique IPs from campus FQDN resolution
CAMPUS_IPS = """172.21.0.96
172.21.0.97
172.21.0.98
172.21.0.99
172.21.0.100
172.21.0.101
172.21.0.102
172.21.0.103
172.21.0.104
172.21.0.105
172.21.0.106
172.21.0.107
172.21.0.108
172.21.0.109
172.21.0.110
172.21.0.111
172.21.0.112
172.21.0.113
172.21.0.114
172.21.0.115
172.21.0.116
172.21.0.117
172.21.0.118
172.21.0.119
172.21.0.120
172.21.0.185
172.21.2.140
172.21.2.141
172.21.2.142
172.21.2.143
172.21.2.144
172.21.3.79
172.21.3.80
172.21.3.81
172.21.3.82
172.21.3.83
172.21.4.135
172.21.4.136
172.21.4.137
172.21.4.138
172.21.4.139
172.21.4.140
172.21.4.141
172.21.4.142
172.21.4.143
172.21.4.144
172.21.5.189
172.21.5.190
172.21.5.191
172.21.5.192
172.21.5.193
172.21.5.194
172.21.5.195
172.21.6.219
172.21.6.220
172.21.6.221
172.21.6.222
172.21.6.223
172.21.6.224
172.21.6.225
172.21.7.11
172.21.7.12
172.21.7.13
172.21.7.14
172.21.7.15
172.21.7.16
172.21.7.17
172.21.7.18
172.21.7.19
172.21.8.23
172.21.8.24
172.21.8.25
172.21.8.26
172.21.8.27
172.21.8.28
172.21.8.29
172.21.8.30
172.21.9.62
172.21.9.63
172.21.9.212
172.21.9.213
172.21.9.214
172.21.9.215
172.21.9.216
172.21.9.217
172.21.9.218
172.21.9.219
172.21.9.220
172.21.9.221
172.21.9.222
172.21.9.223
172.21.9.224
172.21.9.225
172.21.9.226
172.21.9.227
172.21.9.228
172.21.9.229
172.21.9.230
172.21.10.84
172.21.10.85
172.21.10.86
172.21.10.87
172.21.10.88
172.21.10.89
172.21.10.90
172.21.10.91
172.21.10.92
172.21.10.93
172.21.10.94
172.21.10.95
172.21.11.142
172.21.11.143
172.21.11.144
172.21.11.145
172.21.11.146
172.21.11.147
172.21.11.148
172.21.11.149
172.21.11.150
172.21.11.151
172.21.11.152
172.21.11.153
172.21.12.46
172.21.12.125
172.21.12.126
172.21.12.127
172.21.12.128
172.21.12.129
172.21.12.130
172.21.12.131
172.21.12.132
172.21.12.133
172.21.12.134
172.21.12.135
172.21.12.136
172.21.12.137
172.21.12.138
172.21.12.139
172.21.12.140
172.21.12.141
172.21.12.142
172.21.12.143
172.21.12.144
172.21.12.145
172.21.12.146
172.21.12.147
172.21.14.108
172.21.14.109
172.21.14.110
172.21.14.111
172.21.14.112
172.21.14.113
172.21.14.114
172.21.14.115
172.21.14.116
172.21.14.117
172.21.14.118
172.21.14.119
172.21.14.120
172.21.14.121
172.21.14.122
172.21.14.123
172.21.14.124
172.21.14.125
172.21.14.126
172.21.48.25
172.21.48.26
172.21.48.27
172.21.48.28
172.21.48.29
172.21.48.30
172.21.48.31
172.21.48.32
172.21.48.33
172.21.48.34
172.21.48.35
172.21.48.36
172.21.48.37
172.21.48.38
172.21.48.39
172.21.48.40
172.21.48.41
172.21.48.42
172.21.48.43
172.21.48.44
172.21.49.1
172.21.49.2
172.21.49.3
172.21.49.4
172.21.49.5
172.21.49.6
172.21.49.7
172.21.49.8
172.21.49.9
172.21.49.10
172.21.49.11
172.21.49.12
172.21.49.13
172.21.49.14
172.21.49.15
172.21.49.16
172.21.49.17
172.21.49.18
172.21.49.19
172.21.49.20
172.21.50.68
172.21.50.69
172.21.50.70
172.21.50.71
172.21.50.72
172.21.50.73
172.21.50.74
172.21.50.75
172.21.50.76
172.21.50.77
172.21.50.78
172.21.50.79
172.21.50.80
172.21.50.81
172.21.50.82
172.21.50.83
172.21.50.84
172.21.50.85
172.21.50.86
172.21.50.87
172.21.50.88
172.21.51.39
172.21.51.40
172.21.51.41
172.21.51.42
172.21.51.43
172.21.51.44
172.21.51.45
172.21.51.46
172.21.51.47
172.21.51.48
172.21.51.49
172.21.51.50
172.21.51.51
172.21.51.52
172.21.51.53
172.21.51.54
172.21.51.55
172.21.51.56
172.21.51.57
172.21.51.58
172.21.52.77
172.21.52.78
172.21.52.79
172.21.52.80
172.21.52.81
172.21.52.82
172.21.52.83
172.21.52.84
172.21.52.85
172.21.52.86
172.21.52.87
172.21.52.88
172.21.52.89
172.21.52.90
172.21.52.91
172.21.52.92
172.21.52.93
172.21.52.94
172.21.52.95
172.21.52.96
172.21.52.97
172.21.53.1
172.21.53.2
172.21.53.3
172.21.53.4
172.21.53.5
172.21.53.6
172.21.53.7
172.21.53.8
172.21.53.9
172.21.53.10
172.21.53.11
172.21.53.12
172.21.53.13
172.21.53.14
172.21.53.15
172.21.53.16
172.21.53.17
172.21.53.18
172.21.53.19
172.21.53.20
172.21.55.51
172.21.55.52
172.21.55.53
172.21.55.54
172.21.55.55
172.21.55.56
172.21.55.57
172.21.55.58
172.21.55.59
172.21.55.60
172.21.55.61
172.21.55.62
172.21.55.63
172.21.55.64
172.21.55.65
172.21.55.66
172.21.55.67
172.21.55.68
172.21.55.69
172.21.55.70
172.21.56.23
172.21.56.24
172.21.56.25
172.21.56.26
172.21.56.27
172.21.56.28
172.21.56.29
172.21.56.30
172.21.56.31
172.21.56.32
172.21.56.33
172.21.56.34
172.21.56.35
172.21.56.36
172.21.56.37
172.21.56.38
172.21.56.39
172.21.56.40
172.21.56.41
172.21.56.42
172.21.56.43
172.21.56.44
172.21.56.45
172.21.56.46
172.21.56.47
172.21.56.48
172.21.56.49
172.21.56.50
172.21.56.51
172.21.56.52
172.21.56.53
172.21.56.54
172.21.56.55
172.21.56.56
172.21.56.57
172.21.56.58
172.21.56.59
172.21.56.60
172.21.56.61
172.21.56.62
172.21.56.63
172.21.56.64
172.21.56.65
172.21.56.66
172.21.56.67
172.21.56.68
172.21.56.69
172.21.56.70
172.21.56.71
172.21.56.72
172.21.56.73
172.21.56.74
172.21.56.75
172.21.56.76
172.21.56.77
172.21.56.78
172.21.56.79
172.21.56.80
172.21.56.81
172.21.56.82
172.21.56.83
172.21.56.84
172.21.56.85
172.21.56.86
172.21.56.87
172.21.56.88
172.21.56.89
172.21.56.90
172.21.56.91
172.21.56.92
172.21.56.93
172.21.56.94
172.21.56.95
172.21.56.96
172.21.56.97
172.21.56.98
172.21.56.99
172.21.56.100
172.21.56.101
172.21.56.102
172.21.56.103
172.21.56.104
172.21.56.105
172.21.56.106
172.21.56.107
172.21.56.108
172.21.56.109
172.21.56.110
172.21.56.111
172.21.56.112
172.21.56.113
172.21.56.114
172.21.56.115
172.21.56.116
172.21.56.117
172.21.56.118
172.21.56.119
172.21.56.120
172.21.56.121
172.21.56.122
172.21.56.123
172.21.56.124
172.21.56.125
172.21.56.126
172.21.56.127
172.21.56.128
172.21.56.129
172.21.56.130
172.21.56.131
172.21.56.132
172.21.56.133
172.21.56.134
172.21.56.135
172.21.56.136
172.21.56.137
172.21.56.138
172.21.56.139
172.21.56.140
172.21.56.141
172.21.56.142
172.21.56.143
172.21.56.144
172.21.56.145
172.21.56.146
172.21.56.147
172.21.56.148
172.21.56.149
172.21.56.150
172.21.56.151
172.21.56.152
172.21.56.153
172.21.56.154
172.21.56.155
172.21.56.156
172.21.56.157
172.21.56.158
172.21.56.159
172.21.56.160
172.21.56.161
172.21.56.162
172.21.56.163
172.21.56.164
172.21.56.165
172.21.56.166
172.21.56.167
172.21.56.168
172.21.56.169
172.21.56.170
172.21.56.171
172.21.56.172
172.21.56.173
172.21.56.174
172.21.56.175
172.21.56.176
172.21.56.177
172.21.56.178
172.21.56.179
172.21.56.180
172.21.56.181
172.21.56.182
172.21.56.183
172.21.56.184
172.21.56.185
172.21.56.186
172.21.56.187
172.21.56.188
172.21.56.189
172.21.56.190
172.21.56.191
172.21.56.192
172.21.56.193
172.21.56.194
172.21.56.195
172.21.56.196
172.21.56.197
172.21.56.198
172.21.56.199
172.21.56.200
172.21.56.201
172.21.56.202
172.21.56.203
172.21.56.204
172.21.56.205
172.21.56.206
172.21.56.207
172.21.56.208
172.21.56.209
172.21.56.210
172.21.56.211
172.21.56.212
172.21.56.213
172.21.56.214
172.21.56.215
172.21.56.216
172.21.56.217
172.21.56.218
172.21.56.219
172.21.56.220
172.21.56.221
172.21.56.222
172.21.56.223
172.21.56.224
172.21.56.225
172.21.56.226
172.21.56.227
172.21.56.228
172.21.56.229
172.21.56.230
172.21.56.231
172.21.56.232
172.21.56.233
172.21.56.234
172.21.56.235
172.21.56.236
172.21.56.237
172.21.56.238
172.21.56.239
172.21.56.240
172.21.56.241
172.21.56.242
172.21.56.243
172.21.56.244
172.21.56.245
172.21.56.246
172.21.56.247
172.21.56.248
172.21.56.249
172.21.56.250
172.21.56.251
172.21.56.252
172.21.56.253
172.21.56.254""".strip().split('\n')

print(f"Total IPs to add: {len(CAMPUS_IPS)}")

# Add all IPs via PATCH /api/v1/config/discovery/ips/add
endpoint = f"{BASE_URL}/api/v1/config/discovery/ips/add"
payload = {"ips": CAMPUS_IPS}

print(f"Adding {len(CAMPUS_IPS)} IPs to {endpoint}...")
response = requests.patch(
    endpoint,
    json=payload,
    headers=headers,
    verify=False,
    timeout=30
)

print(f"Status: {response.status_code}")
if response.status_code in [200, 202, 204]:
    print("✓ IPs added successfully!")
else:
    print(f"✗ Error: {response.status_code} - {response.text}")
    sys.exit(1)

# Monitor discovery
print("\n" + "="*70)
print("Monitoring device discovery progress...")
print("="*70 + "\n")

last_count = 0
initial_check = True
for i in range(60):  # Check for up to 5 minutes
    try:
        response = requests.get(
            f"{BASE_URL}/api/v1/devices",
            headers=headers,
            verify=False,
            timeout=10
        )
        
        if response.status_code == 200:
            devices = response.json().get('devices', [])
            count = len(devices)
            
            timestamp = time.strftime("%H:%M:%S")
            
            if count > last_count or initial_check:
                print(f"[{timestamp}] Discovered {count} devices", end="")
                if count > last_count:
                    print(f" (↑ +{count - last_count})")
                else:
                    print()
                    
                if initial_check and count > 0:
                    print("  Sample devices:")
                    for device in devices[:3]:
                        model = device.get('modelName', 'Unknown')
                        ip = device.get('ipAddress', 'N/A')
                        status = device.get('deviceStatus', 'Unknown')
                        print(f"    - {model:20} {ip:15} ({status})")
                    initial_check = False
                    
                last_count = count
            else:
                print(f"[{timestamp}] Still {count} devices discovered")
    except Exception as e:
        print(f"Error: {e}")
    
    if i < 59:
        time.sleep(5)

print(f"\nFinal discovery count: {last_count} devices")
